# Azure Communication Services Reference Architecture - GitHub Actions
# ==============================================================================
# CI/CD Pipeline for validating and deploying ACS infrastructure
# ==============================================================================

name: CI/CD Pipeline

on:
  push:
    branches: [main]
    paths:
      - 'infra/**'
      - 'src/**'
      - '.github/workflows/**'
  pull_request:
    branches: [main]
    paths:
      - 'infra/**'
      - 'src/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      deploy:
        description: 'Deploy after validation'
        required: false
        default: false
        type: boolean

env:
  AZURE_REGION: 'swedencentral'

jobs:
  # ==============================================================================
  # Validate Bicep Templates
  # ==============================================================================
  validate-bicep:
    name: Validate Bicep
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bicep
        uses: azure/setup-bicep@v0.3.0

      - name: Bicep Build
        run: |
          echo "Building Bicep templates..."
          bicep build infra/bicep/main.bicep
          echo "✅ Bicep build successful"

      - name: Bicep Lint
        run: |
          echo "Linting Bicep templates..."
          bicep lint infra/bicep/main.bicep
          echo "✅ Bicep lint passed"

      - name: Validate Modules
        run: |
          echo "Validating Bicep modules..."
          for file in infra/bicep/modules/*.bicep; do
            echo "  Validating: $file"
            bicep build "$file" --stdout > /dev/null
          done
          echo "✅ All modules valid"

  # ==============================================================================
  # Validate Python Code
  # ==============================================================================
  validate-python:
    name: Validate Python
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r src/python/requirements.txt
          pip install pylint black isort mypy

      - name: Check formatting with Black
        run: |
          black --check src/python/ || echo "⚠️ Formatting issues found (non-blocking)"

      - name: Check imports with isort
        run: |
          isort --check-only src/python/ || echo "⚠️ Import order issues found (non-blocking)"

      - name: Lint with Pylint
        run: |
          pylint src/python/*.py --exit-zero --reports=y

      - name: Type check with MyPy
        run: |
          mypy src/python/*.py --ignore-missing-imports || echo "⚠️ Type issues found (non-blocking)"

  # ==============================================================================
  # Run Tests
  # ==============================================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: [validate-python]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r src/python/requirements.txt

      - name: Run unit tests
        run: |
          pytest tests/ -v --cov=src/python --cov-report=xml || echo "No tests found yet"

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        if: always()
        with:
          files: ./coverage.xml
          fail_ci_if_error: false

  # ==============================================================================
  # Security Scan
  # ==============================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified

  # ==============================================================================
  # Deploy (manual trigger only)
  # ==============================================================================
  deploy:
    name: Deploy to Azure
    runs-on: ubuntu-latest
    needs: [validate-bicep, validate-python, test, security]
    if: github.event.inputs.deploy == 'true' && github.event_name == 'workflow_dispatch'
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set deployment variables
        id: vars
        run: |
          ENV="${{ github.event.inputs.environment }}"
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "resource_group=rg-acs-$ENV" >> $GITHUB_OUTPUT

      - name: Create Resource Group
        run: |
          az group create \
            --name ${{ steps.vars.outputs.resource_group }} \
            --location ${{ env.AZURE_REGION }} \
            --tags Environment=${{ steps.vars.outputs.environment }} ManagedBy=GitHubActions

      - name: What-If Analysis
        run: |
          az deployment group what-if \
            --name acs-deploy-${{ github.run_number }} \
            --resource-group ${{ steps.vars.outputs.resource_group }} \
            --template-file infra/bicep/main.bicep \
            --parameters infra/bicep/parameters/${{ steps.vars.outputs.environment }}.bicepparam \
            --parameters location=${{ env.AZURE_REGION }}

      - name: Deploy Infrastructure
        run: |
          az deployment group create \
            --name acs-deploy-${{ github.run_number }} \
            --resource-group ${{ steps.vars.outputs.resource_group }} \
            --template-file infra/bicep/main.bicep \
            --parameters infra/bicep/parameters/${{ steps.vars.outputs.environment }}.bicepparam \
            --parameters location=${{ env.AZURE_REGION }}

      - name: Get Deployment Outputs
        run: |
          OUTPUTS=$(az deployment group show \
            --name acs-deploy-${{ github.run_number }} \
            --resource-group ${{ steps.vars.outputs.resource_group }} \
            --query properties.outputs -o json)
          
          echo "## Deployment Outputs" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`json" >> $GITHUB_STEP_SUMMARY
          echo "$OUTPUTS" | jq . >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
